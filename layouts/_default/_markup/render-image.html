{{- $src := .Destination -}}
{{- $alt := .Text -}}
{{- $title := .Title -}}

{{- /* Try to resolve as Hugo resource for image processing */ -}}
{{- $resourcePath := $src -}}
{{- if hasPrefix $resourcePath "/assets/" -}}
  {{- $resourcePath = strings.TrimPrefix "/assets/" $resourcePath -}}
{{- end -}}
{{- $img := resources.Get $resourcePath -}}

{{- if and $img (ne $img.MediaType.SubType "svg") -}}
  {{- $small := $img.Resize "640x webp" -}}
  {{- $medium := $img.Resize "960x webp" -}}
  {{- $large := $img.Resize "1280x webp" -}}
  <img
    src="{{ $medium.RelPermalink }}"
    srcset="{{ $small.RelPermalink }} 640w,
            {{ $medium.RelPermalink }} 960w,
            {{ $large.RelPermalink }} 1280w"
    sizes="(max-width: 640px) 100vw, (max-width: 960px) 960px, 1280px"
    alt="{{ $alt }}"
    {{ with $title }}title="{{ . }}"{{ end }}
    loading="lazy"
    decoding="async"
    width="{{ $medium.Width }}"
    height="{{ $medium.Height }}"
  />
{{- else -}}
  <img
    src="{{ with $img }}{{ .RelPermalink }}{{ else }}{{ $src }}{{ end }}"
    alt="{{ $alt }}"
    {{ with $title }}title="{{ . }}"{{ end }}
    loading="lazy"
    decoding="async"
  />
{{- end -}}
