<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index, follow">
  <meta http-equiv="content-language" content="en">

  <!-- Resource Hints -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Preload Critical Resources -->
  <link rel="preload" href="/assets/css/styles.css" as="style">
  <link rel="preload" href="/assets/css/main.css" as="style">

  <title>Securing and exposing local services with Tailscale and Nginx</title>
  <meta name="description" content="Insights on DevSecOps, cloud architecture, and building secure, scalable systems. Sharing practical experience from running tech companies and implementing software supply chain security at scale.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://vpetersson.com/2022/12/23/securing-services-with-tailscale.html">
  <meta property="og:title" content="Securing and exposing local services with Tailscale and Nginx">
  <meta property="og:description" content="Insights on DevSecOps, cloud architecture, and building secure, scalable systems. Sharing practical experience from running tech companies and implementing software supply chain security at scale.">
  <meta property="og:image" content="https://vpetersson.com/assets/images/site/talk.webp">

  <!-- LinkedIn -->
  <meta property="og:site_name" content="Viktor's Tech Musings & Security Paranoia">
  <meta property="article:author" content="https://www.linkedin.com/in/vpetersson/">
  
  <meta property="article:published_time" content="2022-12-23T12:00:00+00:00">
  

  <!-- X (formerly Twitter) -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@vpetersson">
  <meta name="twitter:creator" content="@vpetersson">
  <meta name="twitter:title" content="Securing and exposing local services with Tailscale and Nginx">
  <meta name="twitter:description" content="Insights on DevSecOps, cloud architecture, and building secure, scalable systems. Sharing practical experience from running tech companies and implementing software supply chain security at scale.">
  <meta name="twitter:image" content="https://vpetersson.com/assets/images/site/talk.webp">

  <!-- Social Profile Links -->
  <link rel="me" href="https://github.com/vpetersson">
  <link rel="me" href="https://www.linkedin.com/in/vpetersson/">
  <link rel="me" href="https://hachyderm.io/@vpetersson@hachyderm.io">

  <!-- Schema.org Person -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Viktor Petersson",
    "url": "https://vpetersson.com",
    "image": "https://vpetersson.com/assets/images/site/talk.webp",
    "sameAs": [
      "https://github.com/vpetersson",
      "https://www.linkedin.com/in/vpetersson/",
      "https://hachyderm.io/@vpetersson@hachyderm.io",
      "https://twitter.com/vpetersson"
    ]
  }
  </script>

  <!-- Custom meta tags -->
  

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Anton|DM Sans|Roboto|Hanken+Grotesk"
    />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/native.css">
  
  <!-- Font Awesome (bundled from node_modules) -->
  <link rel="stylesheet" href="/assets/css/fontawesome-core.css">
  <link rel="stylesheet" href="/assets/css/fontawesome-solid.css">
  <link rel="stylesheet" href="/assets/css/fontawesome-brands.css">

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZY6ZNLNNC8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZY6ZNLNNC8');

  // Track outbound links and CTAs
  function trackEvent(category, action, label, source) {
    gtag('event', action, {
      'event_category': category,
      'event_label': label,
      'source': source
    });
  }
</script>


  <link rel="canonical" href="https://vpetersson.com/2022/12/23/securing-services-with-tailscale.html" />
</head>

  <body>
    <!-- Skip Navigation -->
<a href="#main-content" class="skip-navigation">Skip to main content</a>

<header class="p-8 flex justify-between bg-primaryBG border-b border-white-alpha-20" role="banner">
  <div class="flex gap-10 justify-between items-center">
    <a href="/" aria-label="Viktor Petersson - Home">
      <img src="/assets/images/site/logo-white.svg" alt="Viktor Petersson logo" width="120" height="40" />
    </a>
    <nav class="hidden lg:flex gap-6">
  
    <a href="/" class="text-white uppercase">HOME</a>
  
    <a href="/about" class="text-white uppercase">ABOUT</a>
  
    <a href="/consulting" class="text-white uppercase">CONSULTING</a>
  
    <a href="/podcast" class="text-white uppercase">PODCAST</a>
  
    <a href="/blog" class="text-white uppercase">BLOG</a>
  
    <a href="https://studio.viktopia.io/" class="text-white uppercase">VIKTOPIA STUDIO</a>
  
</nav>

  </div>
  <div class="flex gap-2 justify-between items-center">
    <div class="header-search hidden lg:block">
      <form action="/search" method="get" role="search">
        <label for="searchright" class="sr-only">Search the site</label>
        <input
          class="search expandright"
          id="searchright"
          type="search"
          name="query"
          placeholder="Search"
          aria-label="Search"
        >
        <button class="button searchbutton" type="submit" aria-label="Submit search">
          <span class="mglass" aria-hidden="true">&#9906;</span>
        </button>
      </form>
    </div>

    <div class="hidden lg:block">
      <div class="flex gap-[13px] ">
  <a href="https://twitter.com/vpetersson" target="_new">
    <img src="/assets/images/site/x-white.svg" alt="x logo" />
  </a>
  <a href="https://github.com/vpetersson" target="_new">
    <img src="/assets/images/site/github-white.svg" alt="github logo" />
  </a>
  <a href="https://www.linkedin.com/in/vpetersson/" target="_new">
    <img src="/assets/images/site/linkedin-white.svg" alt="linkedIn logo" />
  </a>
</div>
    </div>

    <!-- Use modern mobile navigation -->
    <!-- Modern Mobile Navigation -->
<div class="mobile-nav-container lg:hidden">
  <!-- Menu Toggle Button -->
  <button
    class="mobile-menu-toggle btn-reset touch-target"
    aria-label="Toggle navigation menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
    data-menu-toggle
  >
    <span class="hamburger-icon" aria-hidden="true">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </span>
  </button>

  <!-- Mobile Menu Backdrop -->
  <div
    class="mobile-menu-backdrop"
    data-menu-backdrop
    aria-hidden="true"
  ></div>

  <!-- Mobile Menu Panel -->
  <nav
    class="mobile-menu"
    id="mobile-menu"
    aria-labelledby="mobile-menu-label"
    data-menu-panel
  >
    <!-- Menu Header -->
    <div class="mobile-menu-header">
      <h2 id="mobile-menu-label" class="sr-only">Navigation Menu</h2>
      <button
        class="mobile-menu-close btn-reset touch-target"
        aria-label="Close navigation menu"
        data-menu-close
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Navigation Links -->
    <ul class="mobile-menu-list" role="list">
      
        <li class="mobile-menu-item">
          <a
            href="/"
            class="mobile-menu-link keyboard-focusable"
            
          >
            HOME
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/about"
            class="mobile-menu-link keyboard-focusable"
            
          >
            ABOUT
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/consulting"
            class="mobile-menu-link keyboard-focusable"
            
          >
            CONSULTING
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/podcast"
            class="mobile-menu-link keyboard-focusable"
            
          >
            PODCAST
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/blog"
            class="mobile-menu-link keyboard-focusable"
            
          >
            BLOG
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="https://studio.viktopia.io/"
            class="mobile-menu-link keyboard-focusable"
            
          >
            VIKTOPIA STUDIO
          </a>
        </li>
      
    </ul>

    <!-- Social Links -->
    <div class="mobile-menu-footer">
      <div class="mobile-social-links">
        <div class="flex gap-[13px] ">
  <a href="https://twitter.com/vpetersson" target="_new">
    <img src="/assets/images/site/x-white.svg" alt="x logo" />
  </a>
  <a href="https://github.com/vpetersson" target="_new">
    <img src="/assets/images/site/github-white.svg" alt="github logo" />
  </a>
  <a href="https://www.linkedin.com/in/vpetersson/" target="_new">
    <img src="/assets/images/site/linkedin-white.svg" alt="linkedIn logo" />
  </a>
</div>
      </div>
    </div>
  </nav>
</div>

<style>
/* Mobile Navigation Styles */
.mobile-nav-container {
  position: relative;
}

.mobile-menu-toggle {
  position: relative;
  z-index: var(--z-fixed);
  color: var(--color-white);
  transition: transform var(--transition-normal);

  &[aria-expanded="true"] {
    transform: rotate(90deg);
  }
}

.hamburger-icon {
  display: flex;
  flex-direction: column;
  width: 24px;
  height: 18px;
  justify-content: space-between;
}

.hamburger-line {
  width: 100%;
  height: 2px;
  background: currentColor;
  border-radius: 1px;
  transition: all var(--transition-normal);
  transform-origin: center;
}

.mobile-menu-toggle[aria-expanded="true"] .hamburger-line {
  &:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }

  &:nth-child(2) {
    opacity: 0;
  }

  &:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }
}

.mobile-menu-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-normal);
  z-index: var(--z-modal);
}

.mobile-menu-backdrop.is-visible {
  opacity: 1;
  visibility: visible;
}

.mobile-menu {
  position: fixed;
  top: 0;
  right: 0;
  width: min(400px, 100vw);
  height: 100vh;
  background: var(--color-gray-900);
  border-left: 1px solid var(--color-gray-200);
  transform: translateX(100%);
  transition: transform var(--transition-normal);
  z-index: var(--z-modal);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overscroll-behavior: contain;
}

.mobile-menu.is-open {
  transform: translateX(0);
}

.mobile-menu-header {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding: var(--space-4);
  border-bottom: 1px solid var(--color-gray-200);
}

.mobile-menu-close {
  color: var(--color-white);
}

.mobile-menu-list {
  flex: 1;
  padding: var(--space-4) 0;
  margin: 0;
  list-style: none;
}

.mobile-menu-item {
  margin: 0;
}

.mobile-menu-link {
  display: block;
  padding: var(--space-3) var(--space-4);
  color: var(--color-white);
  text-decoration: none;
  font-family: var(--font-family-body);
  font-size: var(--font-size-lg);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all var(--transition-normal);
  border-left: 3px solid transparent;

  &:hover {
    background: var(--color-gray-800);
    border-left-color: var(--color-primary);
  }

  &[aria-current="page"] {
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    background: var(--color-gray-800);
  }
}

.mobile-menu-footer {
  padding: var(--space-4);
  border-top: 1px solid var(--color-gray-200);
}

.mobile-social-links {
  display: flex;
  gap: var(--space-3);
  justify-content: center;
}

/* Simple instant display */
.mobile-menu-item {
  opacity: 1;
}
</style>

<script>
// Modern Mobile Navigation JavaScript
(function() {
  const menuToggle = document.querySelector('[data-menu-toggle]');
  const menuPanel = document.querySelector('[data-menu-panel]');
  const menuBackdrop = document.querySelector('[data-menu-backdrop]');
  const menuClose = document.querySelector('[data-menu-close]');
  const menuLinks = document.querySelectorAll('.mobile-menu-link');

  let isOpen = false;

  function openMenu() {
    isOpen = true;
    menuToggle.setAttribute('aria-expanded', 'true');
    menuPanel.classList.add('is-open');
    menuBackdrop.classList.add('is-visible');
    document.body.style.overflow = 'hidden';

    // Focus first menu item
    const firstLink = menuPanel.querySelector('.mobile-menu-link');
    if (firstLink) {
      firstLink.focus();
    }
  }

  function closeMenu() {
    isOpen = false;
    menuToggle.setAttribute('aria-expanded', 'false');
    menuPanel.classList.remove('is-open');
    menuBackdrop.classList.remove('is-visible');
    document.body.style.overflow = '';

    // Return focus to toggle button
    menuToggle.focus();
  }

  function toggleMenu() {
    isOpen ? closeMenu() : openMenu();
  }

  // Event listeners
  menuToggle.addEventListener('click', toggleMenu);
  menuClose.addEventListener('click', closeMenu);
  menuBackdrop.addEventListener('click', closeMenu);

  // Close on link click
  menuLinks.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      closeMenu();
    }
  });

  // Trap focus in menu when open
  menuPanel.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      const focusableElements = menuPanel.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  });
})();
</script>
  </div>
</header>

    <main id="main-content" class="body">
      <!-- Blog post schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://vpetersson.com/2022/12/23/securing-services-with-tailscale.html"
  },
  "headline": "Securing and exposing local services with Tailscale and Nginx",
  "description": null,
  "datePublished": "2022-12-23T12:00:00+00:00",
  "dateModified": "2022-12-23T12:00:00+00:00",
  "author": {
    "@type": "Person",
    "@id": "https://vpetersson.com/about/#person",
    "name": "Viktor Petersson",
    "url": "https://vpetersson.com/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Viktor Petersson",
    "url": "https://vpetersson.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://vpetersson.com/assets/images/site/talk.webp"
    }
  },
  
  "inLanguage": "en",
  "wordCount": "1861",
  "keywords": ["tailscale","nginx","tls","lets-encrypt","cups"]
}
</script>

<!-- Breadcrumbs schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://vpetersson.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://vpetersson.com/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Securing and exposing local services with Tailscale and Nginx",
      "item": "https://vpetersson.com/2022/12/23/securing-services-with-tailscale.html"
    }
  ]
}
</script>
<div class="page-header page-header-blog">
  <h2 class="uppercase text-[48px] md:text-[91px] lg:text-[140px] xl:text-[186px] text-white text-center">Blog</h2>
</div>
<div class="bg-secondaryBG blog-post">
  <div class="md:max-w-[665px] mx-4 sm:mx-6 md:mx-auto py-8 md:py-10 lg:py-20">
    <h2 class="mb-6">Securing and exposing local services with Tailscale and Nginx</h2>
    <div class="flex mb-6 gap-6 text-xs">
      <span class="uppercase">
        23 DEC • 2022
      </span>
      <span class="blog-time">
        11 minutes
      </span>
    </div>
    <article class="leading-[26px]">
      <p>Securing and encrypting communication on local network devices is a hard problem. Plenty of people tried, including myself in our now sunsetted company <a href="https://wott.io/">WoTT</a>. The root of the problem is a combination of DNS and routing to local IPs, which means you can’t use automated certificate issuers, like Let’s Encrypt. The solution, it seems, comes from an unexpected source: the VPN/Wireguard service provider Tailscale.</p>

<p>I’ve been a fan of <a href="https://www.zerotier.com/">ZeroTier</a> for some time and use it both personally and professionally to access nodes behind firewalls. Recently, I kept hearing from more and more people how much they love <a href="https://tailscale.com">Tailscale</a>. After hearing <a href="https://hachyderm.io/@jnsgruk">@jnsgruk</a>’s glowing reviews of Tailscale at Ubuntu Developer Summit, I decided to give it a try.</p>

<p>It’s clearly a much more refined product than ZeroTier. The user interface and user experience are smoother, and it feels more production-ready. After enrolling a few nodes, I was convinced it was time to start migrating.</p>

<p>There isn’t much to write about how to add a machine to Tailscale, as that part is straightforward. What I will focus on in this article is how to use two really neat features in Tailscale to solve the problem in the opening paragraph:</p>

<ul>
  <li><a href="https://tailscale.com/kb/1081/magicdns/">MagicDNS</a></li>
  <li><a href="https://tailscale.com/kb/1153/enabling-https/">SSL Certificates</a> (powered by Let’s Encrypt)</li>
</ul>

<p>Together, this is a game changer.</p>

<p>For some time, I’ve been planning to secure my local web services (Home Assistant, Proxmox etc) with self-signed SSL certificates issued by a local CA (using <a href="https://github.com/cloudflare/cfssl">cfssl</a>). However, this opens a Pandora’s Box of security issues. As you now need to trust a local self-signed CA on all your machines, this could, in theory, be exploited for some really nasty MiTM attacks if someone were to get their hands on the root CA keys.</p>

<p>As it turns out, Tailscale solves this for me, but instead of using self-signed certificates, I get proper certificates issued from Let’s Encrypt.</p>

<p>The way it works is rather elegant. When you enable MagicDNS, you get a domain assigned (e.g. <code class="language-plaintext highlighter-rouge">foobar.ts.net</code>). All your devices will then get a hostname there (e.g. <code class="language-plaintext highlighter-rouge">my-server.foobar.ts.net</code>). Since this is a valid FQDN, Tailscale can use it to issue proper certificates from Let’s Encrypt with the command <code class="language-plaintext highlighter-rouge">tailscale cert my-server.foobar.ts.net</code>.</p>

<p>Just like with regular Let’s Encrypt certificates, these are semi short-lived and thus need to be renewed periodically. As such, we need to automate this renewal on all our hosts with a simple systemd service:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /etc/systemd/system/tailscale-cert.service</span>
<span class="pi">[</span><span class="nv">Unit</span><span class="pi">]</span>
<span class="s">Description=Tailscale SSL Service Renewal</span>
<span class="s">After=network.target syslog.target</span>

<span class="pi">[</span><span class="nv">Service</span><span class="pi">]</span>
<span class="s">Type=oneshot</span>
<span class="s">User=root</span>
<span class="s">Group=root</span>
<span class="s">WorkingDirectory=/etc/ssl/private/</span>
<span class="s">EnvironmentFile=/etc/default/tailscale-cert</span>
<span class="s">ExecStart=/usr/bin/tailscale cert ${HOSTNAME}.${DOMAIN}</span>

<span class="pi">[</span><span class="nv">Install</span><span class="pi">]</span>
<span class="s">WantedBy=multi-user.target</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /etc/systemd/system/tailscale-cert.timer</span>
<span class="pi">[</span><span class="nv">Unit</span><span class="pi">]</span>
<span class="s">Description=Renew Tailscale SSL Certificates</span>

<span class="pi">[</span><span class="nv">Timer</span><span class="pi">]</span>
<span class="s">OnCalendar=weekly</span>
<span class="s">Unit=tailscale-cert.service</span>
<span class="s">Persistent=true</span>

<span class="pi">[</span><span class="nv">Install</span><span class="pi">]</span>
<span class="s">WantedBy=timers.target</span>
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /etc/default/tailscale-cert</span>
<span class="c1"># Configuration for Tailscale SSL Renewal</span>
<span class="s">HOSTNAME=my-server</span>
<span class="s">DOMAIN=foobar.ts.net</span>
</code></pre></div></div>

<p>With these two files created, you can manually start the service to ensure it works:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>systemctl daemon-reload
<span class="nv">$ </span>systemctl start tailscale-cert.service
<span class="nv">$ </span>systemctl <span class="nb">enable </span>tailscale-cert.timer
</code></pre></div></div>

<p>If everything went well, you should now have your certificates in <code class="language-plaintext highlighter-rouge">/etc/ssl/private</code>.</p>

<p>We can then set up a basic Nginx configuration to expose an internal service running on say <code class="language-plaintext highlighter-rouge">localhost:8080</code> by editing <code class="language-plaintext highlighter-rouge">/etc/nginx/sites-enabled/default</code> (or similar):</p>

<div class="language-nginx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">80</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:80</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">return</span> <span class="mi">301</span> <span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">server</span> <span class="p">{</span>
    <span class="kn">listen</span> <span class="mi">443</span> <span class="s">ssl</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:443</span> <span class="s">ssl</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">server_name</span> <span class="s">my-server.foobar.ts.net</span><span class="p">;</span>
    <span class="kn">ssl_certificate</span> <span class="n">/etc/ssl/private/my-server.foobar.ts.net.crt</span><span class="p">;</span>
    <span class="kn">ssl_certificate_key</span> <span class="n">/etc/ssl/private/my-server.foobar.ts.net.key</span><span class="p">;</span>

    <span class="c1"># Consider including the hardening config that Let's Encrypt</span>
    <span class="c1"># recommends for enhanced security.</span>

    <span class="kn">location</span> <span class="n">/</span> <span class="p">{</span>
        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$host</span><span class="p">;</span>
        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://localhost:8080</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>You should now be able to navigate to your server using a <strong>proper</strong> SSL certificate at the address https://my-server.foobar.ts.net. Pretty neat.</p>

<p>There’s even an <a href="https://tailscale.com/blog/tailscale-auth-nginx/">official Nginx auth</a> that can be used. I haven’t experimented with this yet, but it could presumably be used to further secure your Nginx reverse proxies.</p>

<p>Below are some notes that I encountered while setting this up on various systems.</p>

<h2 id="home-assistant">Home Assistant</h2>

<p>By default, Home Assistant will complain if you try to access it over a proxy. To overcome this, you need to add this in <code class="language-plaintext highlighter-rouge">configuration.yaml</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">http</span><span class="pi">:</span>
 <span class="na">use_x_forwarded_for</span><span class="pi">:</span> <span class="kc">true</span>
 <span class="na">trusted_proxies</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="s">127.0.0.1</span>
</code></pre></div></div>

<p>You may also need to tweak your Nginx config for working with WebSocket.</p>

<h3 id="home-assistant-and-mysql-with-tls">Home Assistant and MySQL with TLS</h3>

<p>If you’re intending to connect to a MariaDB/MySQL instance using TLS, <a href="https://www.home-assistant.io/integrations/recorder/#mariadb-omit-pymysql-using-tls-encryption">the official documentation</a> is incorrect. As <a href="https://community.home-assistant.io/t/mysql-through-an-ssl-connection/453607">this forum post</a> correctly points out, instead of <code class="language-plaintext highlighter-rouge">;ssl=true</code>, you need to append <code class="language-plaintext highlighter-rouge">&amp;ssl=true</code>.</p>

<p>However, note that Home Assistant <em>does not</em> actually verify the SSL certificate, thus making it vulnerable to a MiTM attack.</p>

<h3 id="home-assistant-and-influxdb-with-tls">Home Assistant and InfluxDB with TLS</h3>

<p>To use InfluxDB with TLS, you need to make the following changes to your Home Assistant YAML file:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">influxdb</span><span class="pi">:</span>
  <span class="na">api_version</span><span class="pi">:</span> <span class="m">2</span>
  <span class="na">ssl</span><span class="pi">:</span> <span class="kc">true</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">influxdb.foobar.ts.net</span>
  <span class="na">port</span><span class="pi">:</span> <span class="m">8086</span>
</code></pre></div></div>

<h2 id="proxmox">Proxmox</h2>

<p>Setting up Tailscale on Proxmox was just like any other system. The somewhat tricky part was to consume the certificate. To accomplish this, I added the following line after <code class="language-plaintext highlighter-rouge">ExecStart</code> in <code class="language-plaintext highlighter-rouge">/etc/systemd/system/tailscale-cert.service</code>, which instructs Proxmox to use the certificates issued from Tailscale:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">ExecStartPost=pvenode cert set /etc/ssl/private/${HOSTNAME}.foobar.ts.net.crt /etc/ssl/private/${HOSTNAME}.foobar.ts.net.key --force 1 --restart </span><span class="m">1</span>
</code></pre></div></div>

<p>Somewhat unrelated to the certificates, but in order to install Tailscale on an LXC container, you need to run it in privileged mode as per <a href="https://tailscale.com/kb/1130/lxc-unprivileged/">this document</a> and add to the config:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lxc.cgroup2.devices.allow: c 10:200 rwm
lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file
</code></pre></div></div>

<p>Note that you can’t move a container to privileged mode from unprivileged, as this will break file permissions and other things in the container. The way to accomplish this is to take a backup of the container, and then <strong>restore</strong> the container as privileged.</p>

<h2 id="mariadbmysql">MariaDB/MySQL</h2>

<p>To use the certificate with MariaDB/MySQL, we need to modify our setup slightly to accommodate permissions.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /etc/systemd/system/tailscale-cert.service</span>
<span class="pi">[</span><span class="nv">Unit</span><span class="pi">]</span>
<span class="s">Description=Tailscale SSL Service Renewal</span>
<span class="s">After=network.target</span>
<span class="s">After=syslog.target</span>

<span class="pi">[</span><span class="nv">Service</span><span class="pi">]</span>
<span class="s">Type=oneshot</span>
<span class="s">User=root</span>
<span class="s">Group=root</span>
<span class="s">Environment="HOSTNAME=mariadb"</span>
<span class="s">ExecStart=/usr/local/sbin/tailscale-mysql.sh</span>
<span class="pi">[</span><span class="nv">Install</span><span class="pi">]</span>
<span class="s">WantedBy=multi-user.target</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-euo</span> pipefail
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n\t</span><span class="s1">'</span>

<span class="nb">mkdir</span> <span class="nt">-p</span> /etc/mysql/ssl
tailscale cert <span class="se">\</span>
    <span class="nt">--cert-file</span> /etc/mysql/ssl/cert.crt <span class="se">\</span>
    <span class="nt">--key-file</span> /etc/mysql/ssl/cert.key <span class="se">\</span>
    <span class="k">${</span><span class="nv">HOSTNAME</span><span class="k">}</span>.foobar.ts.net
<span class="nb">chown </span>mysql:mysql <span class="nt">-R</span> /etc/mysql/ssl
<span class="nb">chmod </span>0660 /etc/mysql/ssl/cert<span class="k">*</span>
</code></pre></div></div>

<p>With this done, we just need to tell MariaDB/MySQL to use these certificates:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># /etc/mysql/mariadb.conf.d/50-server.cnf</span>
<span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="c1"># We need to point to a CA path instead of the CA file since we</span>
<span class="c1"># are using a proper certificate.</span>
<span class="s">ssl-capath = /etc/ssl/certs/</span>
<span class="s">ssl-cert = /etc/mysql/ssl/cert.crt</span>
<span class="s">ssl-key = /etc/mysql/ssl/cert.key</span>
<span class="s">require-secure-transport = on</span>

<span class="c1"># We don't want to allow lower ciphers than 1.2 as per NIST etc</span>
<span class="s">tls_version=TLSv1.2</span>
<span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
</code></pre></div></div>

<p>Finally, restart the service with <code class="language-plaintext highlighter-rouge">systemctl restart mysql</code>.</p>

<p>You might also want to recreate your MySQL user and add the constraint <code class="language-plaintext highlighter-rouge">REQUIRE SSL;</code> to ensure the remote users only can connect using TLS (even though that should in theory also be done using <code class="language-plaintext highlighter-rouge">require-secure-transport</code>).</p>

<h2 id="influxdb-2">InfluxDB 2</h2>

<p>Much like MariaDB/MySQL, setting up InfluxDB requires a bit extra work with permission.</p>

<p>We start with a unit that fires a Bash script</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#/etc/systemd/system/tailscale-cert.service</span>
<span class="pi">[</span><span class="nv">Unit</span><span class="pi">]</span>
<span class="s">Description=Tailscale SSL Service Renewal</span>
<span class="s">After=network.target</span>
<span class="s">After=syslog.target</span>

<span class="pi">[</span><span class="nv">Service</span><span class="pi">]</span>
<span class="s">Type=oneshot</span>
<span class="s">User=root</span>
<span class="s">Group=root</span>
<span class="s">Environment="HOSTNAME=influxdb"</span>
<span class="s">ExecStart=/usr/local/sbin/tailscale-influxdb.sh</span>

<span class="pi">[</span><span class="nv">Install</span><span class="pi">]</span>
<span class="s">WantedBy=multi-user.target</span>
</code></pre></div></div>

<p>We then create the bash script:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-euo</span> pipefail
<span class="nv">IFS</span><span class="o">=</span><span class="s1">$'</span><span class="se">\n\t</span><span class="s1">'</span>

<span class="nb">mkdir</span> <span class="nt">-p</span> /etc/influxdb/ssl
tailscale cert <span class="se">\</span>
    <span class="nt">--cert-file</span> /etc/influxdb/ssl/cert.crt <span class="se">\</span>
    <span class="nt">--key-file</span> /etc/influxdb/ssl/cert.key <span class="se">\</span>
    <span class="k">${</span><span class="nv">HOSTNAME</span><span class="k">}</span>.foobar.ts.net
<span class="nb">chown </span>influxdb:influxdb <span class="nt">-R</span> /etc/influxdb/ssl
<span class="nb">chmod </span>0660 /etc/influxdb/ssl/cert<span class="k">*</span>
</code></pre></div></div>

<p>Upon starting this script, we should now get our certificates in place. The only thing we need to do now is to edit the configuration file to have it consume our certificate:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># /etc/influxdb/config.toml</span>
<span class="n">bolt-path</span> <span class="o">=</span><span class="w"> </span><span class="s">"/var/lib/influxdb/influxd.bolt"</span>
<span class="n">engine-path</span> <span class="o">=</span><span class="w"> </span><span class="s">"/var/lib/influxdb/engine"</span>
<span class="n">tls-cert</span> <span class="o">=</span><span class="w"> </span><span class="s">"/etc/influxdb/ssl/cert.crt"</span>
<span class="n">tls-key</span> <span class="o">=</span><span class="w">  </span><span class="s">"/etc/influxdb/ssl/cert.key"</span>
</code></pre></div></div>

<p>Restarting the service will automatically make InfluxDB serve content over HTTPS.</p>

<h2 id="opnsense">OPNsense</h2>

<p>I’m yet to add support for this. It should certainly be possible, but BSD isn’t an officially supported platform. Moreover, because OPNSense uses its own CA for things like VPN configuration, it might be a bit more challenging.</p>

<h2 id="cups">CUPS</h2>

<p>Configuring <a href="https://www.cups.org/">CUPS</a> to use Tailscale was rather straightforward.</p>

<p>After installing the systemd unit and timer, you should have your certificate available.</p>

<p>Next, open up <code class="language-plaintext highlighter-rouge">/etc/cups/cups-files.conf</code> and add <code class="language-plaintext highlighter-rouge">CreateSelfSignedCerts no</code> to prevent CUPS from issuing its self-signed certificates.</p>

<p>Next, delete all existing self-signed certificates by running <code class="language-plaintext highlighter-rouge">sudo find -type f /etc/cups/ssl -delete</code>.</p>

<p>We now need to set up a symlink to our existing Tailscale certificates to a place where CUPS is looking for them (i.e. <code class="language-plaintext highlighter-rouge">/etc/cups/ssl</code>). This is done by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo ln</span> <span class="nt">-s</span> /etc/ssl/private/my-box.foobar.ts.net.<span class="o">{</span>crt,key<span class="o">}</span> /etc/cups/ssl/
</code></pre></div></div>

<p>Finally, we need to make some tweaks to <code class="language-plaintext highlighter-rouge">/etc/cups/cupsd.conf</code>:</p>

<ul>
  <li>Modify the <code class="language-plaintext highlighter-rouge">ServerAlias</code> stanza to match your Tailscale hostname, such as <code class="language-plaintext highlighter-rouge">ServerAlias my-box.foobar.ts.net.ts.net</code></li>
  <li>Set the <code class="language-plaintext highlighter-rouge">Listen</code> stanza to only listen on the Tailscale interface, by doing <code class="language-plaintext highlighter-rouge">Listen my-box.foobar.ts.net.ts.net</code></li>
  <li>We also probably want to set <code class="language-plaintext highlighter-rouge">Browsing On</code> so that we can easier find the printers</li>
</ul>

<p>Lastly, we need to edit all the relevant <code class="language-plaintext highlighter-rouge">&lt;location&gt;</code> blocks and add <code class="language-plaintext highlighter-rouge">allow all</code> to the configuration. Initially, I was planning to use the <code class="language-plaintext highlighter-rouge">@IF(tailscale0)</code> macro (<a href="https://www.cups.org/doc/man-cupsd.conf.html">cupsd.conf</a>), but I wasn’t able to get this working and didn’t dive much further into it.</p>

<p>With all those changes live, you can just restart CUPS (<code class="language-plaintext highlighter-rouge">sudo systemctl restart cups</code>), and you should be good to go.</p>

<p>To add the printer on macOS, just add it as an IP printer with the hostname being the Tailscale hostname and then the <code class="language-plaintext highlighter-rouge">/printers/&lt;name of printer&gt;</code> as the Queue.</p>


      <div class="mt-12 mb-8 p-8 bg-blue-50 border border-blue-100 rounded-xl">
        <h4 class="text-2xl font-semibold mb-4 text-blue-900">Enjoyed this post? Check out my podcast!</h4>
        <p class="mb-6 text-blue-800">If you found this interesting, you might enjoy <a href="/podcast" class="text-blue-600 hover:text-blue-800 underline" onclick="trackEvent('Blog CTA', 'Click', 'Podcast Link', 'Securing and exposing local services with Tailscale and Nginx')">"Nerding Out with Viktor"</a> - my podcast where I dive deep into tech, entrepreneurship, and security with industry experts.</p>
        <div>
          <h5 class="font-medium mb-4 text-blue-900">Listen on:</h5>
          



<div>
  <div class="flex gap-3">
    
      <a href="https://www.youtube.com/@nerdingoutwithviktor" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'YouTube', 'Securing and exposing local services with Tailscale and Nginx')">
        <img src="/assets/images/site/podcast-youtube-white.svg" alt="Listen to podcast on YouTube" />
      </a>
    
    
      <a href="https://open.spotify.com/show/7C6yipdVPWgBc6Bwikgo8g" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'Spotify', 'Securing and exposing local services with Tailscale and Nginx')">
        <img src="/assets/images/site/podcast-spotify-white.svg" alt="Listen to podcast on Spotify" />
      </a>
    
    
      <a href="https://podcasts.apple.com/us/podcast/nerding-out-with-viktor/id1722663295" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'Apple', 'Securing and exposing local services with Tailscale and Nginx')">
        <img src="/assets/images/site/podcast-apple-white.svg" alt="Listen to podcast on Apple" />
      </a>
    
    
    
      <a href="https://podcast.nerdingoutwithviktor.com/podcast_feed.xml" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'RSS', 'Securing and exposing local services with Tailscale and Nginx')">
        <img src="/assets/images/site/podcast-rss-white.svg" alt="RSS Feed" />
      </a>
    
  </div>
</div>

        </div>
      </div>

      <i>Found an error or typo? File PR against <a href="https://github.com/vpetersson/vpetersson.com/tree/master/_posts/2022-12-23-securing-services-with-tailscale.md" rel="nofollow">this file</a>.</i>
    </article>
    <div class="mt-6">
      
  <div class="tags">
    
      <a href="/tags/tailscale" class="tag">
        tailscale
      </a>
    
      <a href="/tags/nginx" class="tag">
        nginx
      </a>
    
      <a href="/tags/tls" class="tag">
        tls
      </a>
    
      <a href="/tags/lets-encrypt" class="tag">
        lets-encrypt
      </a>
    
      <a href="/tags/cups" class="tag">
        cups
      </a>
    
  </div>


    </div>
  </div>
</div>


    </main>
    <footer class="py-[60px] md:pt-[74px] md:pb-[40px] px-[25px] md:px-[120px] text-altPrimaryText">
  <div class="mb-[60px]">
    <a href="/">
      <img class="w-[200px] md:w-[320px]" src="/assets/images/site/logo.svg" alt="logo" />
    </a>
  </div>
  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8 lg:mb-6">
    <nav class="flex flex-col md:flex-row gap-6 md:gap-8 mb-20 lg:mb-0">
      
        <a href="/" class="">HOME</a>
      
        <a href="/about" class="">ABOUT</a>
      
        <a href="/consulting" class="">CONSULTING</a>
      
        <a href="/podcast" class="">PODCAST</a>
      
        <a href="/blog" class="">BLOG</a>
      
        <a href="https://studio.viktopia.io/" class="">VIKTOPIA STUDIO</a>
      
    </nav>
    <div class="flex gap-[13px]">
      <a href="https://twitter.com/vpetersson">
        <img src="/assets/images/site/x.svg" alt="x logo" />
      </a>
      <a href="https://github.com/vpetersson">
        <img src="/assets/images/site/github.svg" alt="github logo" />
      </a>
      <a href="https://www.linkedin.com/in/vpetersson/">
        <img src="/assets/images/site/linkedin.svg" alt="linkedIn logo" />
      </a>
    </div>
  </div>
  <hr class="mb-8 lg:mb-10 bg-[#000212] h-[3px] bg-opacity-20 border-0" />
  <div>
    <p class="font-[Inter] text-base">&copy; Viktor Petersson</p>
  </div>
</footer>

    <script src="/assets/js/main.js" defer></script>
    <script src="/assets/js/code-blocks.js" defer></script>
  </body>
</html>
