<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index, follow">
  <meta http-equiv="content-language" content="en">

  <!-- Resource Hints -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">

  <!-- Preload Critical Resources -->
  <link rel="preload" href="/assets/css/styles.css" as="style">
  <link rel="preload" href="/assets/css/main.css" as="style">

  <title>Notes on MongoDB, GridFS, sharding  and deploying in the cloud</title>
  <meta name="description" content="Insights on DevSecOps, cloud architecture, and building secure, scalable systems. Sharing practical experience from running tech companies and implementing software supply chain security at scale.">

  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://vpetersson.com/2012/01/29/notes-on-mongodb-gridfs-and-sharding-in-the-cloud.html">
  <meta property="og:title" content="Notes on MongoDB, GridFS, sharding  and deploying in the cloud">
  <meta property="og:description" content="Insights on DevSecOps, cloud architecture, and building secure, scalable systems. Sharing practical experience from running tech companies and implementing software supply chain security at scale.">
  <meta property="og:image" content="https://vpetersson.com/assets/images/site/talk.webp">

  <!-- LinkedIn -->
  <meta property="og:site_name" content="Viktor's Tech Musings & Security Paranoia">
  <meta property="article:author" content="https://www.linkedin.com/in/vpetersson/">
  
  <meta property="article:published_time" content="2012-01-29T12:24:18+00:00">
  

  <!-- X (formerly Twitter) -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@vpetersson">
  <meta name="twitter:creator" content="@vpetersson">
  <meta name="twitter:title" content="Notes on MongoDB, GridFS, sharding  and deploying in the cloud">
  <meta name="twitter:description" content="Insights on DevSecOps, cloud architecture, and building secure, scalable systems. Sharing practical experience from running tech companies and implementing software supply chain security at scale.">
  <meta name="twitter:image" content="https://vpetersson.com/assets/images/site/talk.webp">

  <!-- Social Profile Links -->
  <link rel="me" href="https://github.com/vpetersson">
  <link rel="me" href="https://www.linkedin.com/in/vpetersson/">
  <link rel="me" href="https://hachyderm.io/@vpetersson@hachyderm.io">

  <!-- Schema.org Person -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Person",
    "name": "Viktor Petersson",
    "url": "https://vpetersson.com",
    "image": "https://vpetersson.com/assets/images/site/talk.webp",
    "sameAs": [
      "https://github.com/vpetersson",
      "https://www.linkedin.com/in/vpetersson/",
      "https://hachyderm.io/@vpetersson@hachyderm.io",
      "https://twitter.com/vpetersson"
    ]
  }
  </script>

  <!-- Custom meta tags -->
  

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Anton|DM Sans|Roboto|Hanken+Grotesk"
    />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Fira+Code:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Styles -->
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/native.css">
  
  <!-- Font Awesome (bundled from node_modules) -->
  <link rel="stylesheet" href="/assets/css/fontawesome-core.css">
  <link rel="stylesheet" href="/assets/css/fontawesome-solid.css">
  <link rel="stylesheet" href="/assets/css/fontawesome-brands.css">

  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-ZY6ZNLNNC8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-ZY6ZNLNNC8');

  // Track outbound links and CTAs
  function trackEvent(category, action, label, source) {
    gtag('event', action, {
      'event_category': category,
      'event_label': label,
      'source': source
    });
  }
</script>


  <link rel="canonical" href="https://vpetersson.com/2012/01/29/notes-on-mongodb-gridfs-and-sharding-in-the-cloud.html" />
</head>

  <body>
    <!-- Skip Navigation -->
<a href="#main-content" class="skip-navigation">Skip to main content</a>

<header class="p-8 flex justify-between bg-primaryBG border-b border-white-alpha-20" role="banner">
  <div class="flex gap-10 justify-between items-center">
    <a href="/" aria-label="Viktor Petersson - Home">
      <img src="/assets/images/site/logo-white.svg" alt="Viktor Petersson logo" width="120" height="40" />
    </a>
    <nav class="hidden lg:flex gap-6">
  
    <a href="/" class="text-white uppercase">HOME</a>
  
    <a href="/about" class="text-white uppercase">ABOUT</a>
  
    <a href="/consulting" class="text-white uppercase">CONSULTING</a>
  
    <a href="/podcast" class="text-white uppercase">PODCAST</a>
  
    <a href="/blog" class="text-white uppercase">BLOG</a>
  
    <a href="https://studio.viktopia.io/" class="text-white uppercase">VIKTOPIA STUDIO</a>
  
</nav>

  </div>
  <div class="flex gap-2 justify-between items-center">
    <div class="header-search hidden lg:block">
      <form action="/search" method="get" role="search">
        <label for="searchright" class="sr-only">Search the site</label>
        <input
          class="search expandright"
          id="searchright"
          type="search"
          name="query"
          placeholder="Search"
          aria-label="Search"
        >
        <button class="button searchbutton" type="submit" aria-label="Submit search">
          <span class="mglass" aria-hidden="true">&#9906;</span>
        </button>
      </form>
    </div>

    <div class="hidden lg:block">
      <div class="flex gap-[13px] ">
  <a href="https://twitter.com/vpetersson" target="_new">
    <img src="/assets/images/site/x-white.svg" alt="x logo" />
  </a>
  <a href="https://github.com/vpetersson" target="_new">
    <img src="/assets/images/site/github-white.svg" alt="github logo" />
  </a>
  <a href="https://www.linkedin.com/in/vpetersson/" target="_new">
    <img src="/assets/images/site/linkedin-white.svg" alt="linkedIn logo" />
  </a>
</div>
    </div>

    <!-- Use modern mobile navigation -->
    <!-- Modern Mobile Navigation -->
<div class="mobile-nav-container lg:hidden">
  <!-- Menu Toggle Button -->
  <button
    class="mobile-menu-toggle btn-reset touch-target"
    aria-label="Toggle navigation menu"
    aria-expanded="false"
    aria-controls="mobile-menu"
    data-menu-toggle
  >
    <span class="hamburger-icon" aria-hidden="true">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </span>
  </button>

  <!-- Mobile Menu Backdrop -->
  <div
    class="mobile-menu-backdrop"
    data-menu-backdrop
    aria-hidden="true"
  ></div>

  <!-- Mobile Menu Panel -->
  <nav
    class="mobile-menu"
    id="mobile-menu"
    aria-labelledby="mobile-menu-label"
    data-menu-panel
  >
    <!-- Menu Header -->
    <div class="mobile-menu-header">
      <h2 id="mobile-menu-label" class="sr-only">Navigation Menu</h2>
      <button
        class="mobile-menu-close btn-reset touch-target"
        aria-label="Close navigation menu"
        data-menu-close
      >
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M18 6L6 18M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Navigation Links -->
    <ul class="mobile-menu-list" role="list">
      
        <li class="mobile-menu-item">
          <a
            href="/"
            class="mobile-menu-link keyboard-focusable"
            
          >
            HOME
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/about"
            class="mobile-menu-link keyboard-focusable"
            
          >
            ABOUT
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/consulting"
            class="mobile-menu-link keyboard-focusable"
            
          >
            CONSULTING
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/podcast"
            class="mobile-menu-link keyboard-focusable"
            
          >
            PODCAST
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="/blog"
            class="mobile-menu-link keyboard-focusable"
            
          >
            BLOG
          </a>
        </li>
      
        <li class="mobile-menu-item">
          <a
            href="https://studio.viktopia.io/"
            class="mobile-menu-link keyboard-focusable"
            
          >
            VIKTOPIA STUDIO
          </a>
        </li>
      
    </ul>

    <!-- Social Links -->
    <div class="mobile-menu-footer">
      <div class="mobile-social-links">
        <div class="flex gap-[13px] ">
  <a href="https://twitter.com/vpetersson" target="_new">
    <img src="/assets/images/site/x-white.svg" alt="x logo" />
  </a>
  <a href="https://github.com/vpetersson" target="_new">
    <img src="/assets/images/site/github-white.svg" alt="github logo" />
  </a>
  <a href="https://www.linkedin.com/in/vpetersson/" target="_new">
    <img src="/assets/images/site/linkedin-white.svg" alt="linkedIn logo" />
  </a>
</div>
      </div>
    </div>
  </nav>
</div>

<style>
/* Mobile Navigation Styles */
.mobile-nav-container {
  position: relative;
}

.mobile-menu-toggle {
  position: relative;
  z-index: var(--z-fixed);
  color: var(--color-white);
  transition: transform var(--transition-normal);

  &[aria-expanded="true"] {
    transform: rotate(90deg);
  }
}

.hamburger-icon {
  display: flex;
  flex-direction: column;
  width: 24px;
  height: 18px;
  justify-content: space-between;
}

.hamburger-line {
  width: 100%;
  height: 2px;
  background: currentColor;
  border-radius: 1px;
  transition: all var(--transition-normal);
  transform-origin: center;
}

.mobile-menu-toggle[aria-expanded="true"] .hamburger-line {
  &:nth-child(1) {
    transform: rotate(45deg) translate(6px, 6px);
  }

  &:nth-child(2) {
    opacity: 0;
  }

  &:nth-child(3) {
    transform: rotate(-45deg) translate(6px, -6px);
  }
}

.mobile-menu-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(4px);
  opacity: 0;
  visibility: hidden;
  transition: all var(--transition-normal);
  z-index: var(--z-modal);
}

.mobile-menu-backdrop.is-visible {
  opacity: 1;
  visibility: visible;
}

.mobile-menu {
  position: fixed;
  top: 0;
  right: 0;
  width: min(400px, 100vw);
  height: 100vh;
  background: var(--color-gray-900);
  border-left: 1px solid var(--color-gray-200);
  transform: translateX(100%);
  transition: transform var(--transition-normal);
  z-index: var(--z-modal);
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  overscroll-behavior: contain;
}

.mobile-menu.is-open {
  transform: translateX(0);
}

.mobile-menu-header {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  padding: var(--space-4);
  border-bottom: 1px solid var(--color-gray-200);
}

.mobile-menu-close {
  color: var(--color-white);
}

.mobile-menu-list {
  flex: 1;
  padding: var(--space-4) 0;
  margin: 0;
  list-style: none;
}

.mobile-menu-item {
  margin: 0;
}

.mobile-menu-link {
  display: block;
  padding: var(--space-3) var(--space-4);
  color: var(--color-white);
  text-decoration: none;
  font-family: var(--font-family-body);
  font-size: var(--font-size-lg);
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  transition: all var(--transition-normal);
  border-left: 3px solid transparent;

  &:hover {
    background: var(--color-gray-800);
    border-left-color: var(--color-primary);
  }

  &[aria-current="page"] {
    color: var(--color-primary);
    border-left-color: var(--color-primary);
    background: var(--color-gray-800);
  }
}

.mobile-menu-footer {
  padding: var(--space-4);
  border-top: 1px solid var(--color-gray-200);
}

.mobile-social-links {
  display: flex;
  gap: var(--space-3);
  justify-content: center;
}

/* Simple instant display */
.mobile-menu-item {
  opacity: 1;
}
</style>

<script>
// Modern Mobile Navigation JavaScript
(function() {
  const menuToggle = document.querySelector('[data-menu-toggle]');
  const menuPanel = document.querySelector('[data-menu-panel]');
  const menuBackdrop = document.querySelector('[data-menu-backdrop]');
  const menuClose = document.querySelector('[data-menu-close]');
  const menuLinks = document.querySelectorAll('.mobile-menu-link');

  let isOpen = false;

  function openMenu() {
    isOpen = true;
    menuToggle.setAttribute('aria-expanded', 'true');
    menuPanel.classList.add('is-open');
    menuBackdrop.classList.add('is-visible');
    document.body.style.overflow = 'hidden';

    // Focus first menu item
    const firstLink = menuPanel.querySelector('.mobile-menu-link');
    if (firstLink) {
      firstLink.focus();
    }
  }

  function closeMenu() {
    isOpen = false;
    menuToggle.setAttribute('aria-expanded', 'false');
    menuPanel.classList.remove('is-open');
    menuBackdrop.classList.remove('is-visible');
    document.body.style.overflow = '';

    // Return focus to toggle button
    menuToggle.focus();
  }

  function toggleMenu() {
    isOpen ? closeMenu() : openMenu();
  }

  // Event listeners
  menuToggle.addEventListener('click', toggleMenu);
  menuClose.addEventListener('click', closeMenu);
  menuBackdrop.addEventListener('click', closeMenu);

  // Close on link click
  menuLinks.forEach(link => {
    link.addEventListener('click', closeMenu);
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      closeMenu();
    }
  });

  // Trap focus in menu when open
  menuPanel.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      const focusableElements = menuPanel.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      const firstElement = focusableElements[0];
      const lastElement = focusableElements[focusableElements.length - 1];

      if (e.shiftKey && document.activeElement === firstElement) {
        e.preventDefault();
        lastElement.focus();
      } else if (!e.shiftKey && document.activeElement === lastElement) {
        e.preventDefault();
        firstElement.focus();
      }
    }
  });
})();
</script>
  </div>
</header>

    <main id="main-content" class="body">
      <!-- Blog post schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://vpetersson.com/2012/01/29/notes-on-mongodb-gridfs-and-sharding-in-the-cloud.html"
  },
  "headline": "Notes on MongoDB, GridFS, sharding  and deploying in the cloud",
  "description": null,
  "datePublished": "2012-01-29T12:24:18+00:00",
  "dateModified": "2012-01-29T12:24:18+00:00",
  "author": {
    "@type": "Person",
    "@id": "https://vpetersson.com/about/#person",
    "name": "Viktor Petersson",
    "url": "https://vpetersson.com/about/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Viktor Petersson",
    "url": "https://vpetersson.com",
    "logo": {
      "@type": "ImageObject",
      "url": "https://vpetersson.com/assets/images/site/talk.webp"
    }
  },
  
  "inLanguage": "en",
  "wordCount": "1437",
  "keywords": ["MongoDB"]
}
</script>

<!-- Breadcrumbs schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://vpetersson.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Blog",
      "item": "https://vpetersson.com/blog/"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Notes on MongoDB, GridFS, sharding  and deploying in the cloud",
      "item": "https://vpetersson.com/2012/01/29/notes-on-mongodb-gridfs-and-sharding-in-the-cloud.html"
    }
  ]
}
</script>
<div class="page-header page-header-blog">
  <h2 class="uppercase text-[48px] md:text-[91px] lg:text-[140px] xl:text-[186px] text-white text-center">Blog</h2>
</div>
<div class="bg-secondaryBG blog-post">
  <div class="md:max-w-[665px] mx-4 sm:mx-6 md:mx-auto py-8 md:py-10 lg:py-20">
    <h2 class="mb-6">Notes on MongoDB, GridFS, sharding  and deploying in the cloud</h2>
    <div class="flex mb-6 gap-6 text-xs">
      <span class="uppercase">
        29 JAN • 2012
      </span>
      <span class="blog-time">
        8 minutes
      </span>
    </div>
    <article class="leading-[26px]">
      <p><a href="http://wireload.net">We</a>‘ve been using MongoDB in production for about six months with <a href="http://www.yippiemove.com">YippieMove</a>. It’s been an interesting experience and we’ve learned a lot.</p>

<p>Contrary to many MongoDB deployments, we primarily use it for storing files in GridFS. We switched over to MongoDB after searching for a good distributed file system for years. Prior to MongoDB we used a regular NFS share, sitting on top of a <a href="/2010/09/27/setting-up-a-redundant-nas-with-hast-with-carp.html">HAST</a>-device. That worked great, but it didn’t allow us to scale horizontally the way a distributed file system allows.</p>

<p>Enter MongoDB. Just like most people playing around with MongoDB, we started out with a simple <a href="http://www.mongodb.org/display/DOCS/Replica+Sets">Replica Set</a>, but are now in the process of switching to a sharded setup.</p>

<p>In the post, I will go over some of the things we’ve learned when using MongoDB.</p>

<h2 id="running-mongodb-in-the-cloud">Running MongoDB in the Cloud</h2>

<p>One major thing to keep in mind when deploying MongoDB is that it matters a lot if you are deploying in a public cloud or on dedicated server. We deployed in a public cloud. While we did get good performance compared to many other cloud vendors, the performance were of course not at par with beefy dedicated servers (but came with other benefits instead).</p>

<p>The biggest constrain with running in the cloud is limited I/O performance. We get about 60-80MB/s in writes, and 80-100MB/s in reads from our disks. That isn’t super fast for something like MongoDB, and we need to keep that in mind when we design the architecture.</p>

<p>When we started out, we started with a replica set with three members (Primary + 2x Secondary). That worked well initially, and it felt good knowing that all data was backed up 3x. The problem however was that during heavy load, we saw that the secondary nodes fell behind. If the heavy load lasted long, the secondary nodes fell far behind such that they fell out of the opsize, and hence couldn’t catch up.</p>

<p>To cope with this, we changed our strategy a bit and turned one of the secondaries into an arbiter. That offloaded the primary server significantly. If one were to run with dedicated servers on beefy hardware, I do not think this would be an issue at all. This was primarily due to the low I/O performance, and a cloud-specific issue.</p>

<p>The setup we ended up then with was as follows:</p>

<p><img src="https://vpetersson.com/upload/primary_secondary_arbiter.png" alt="" title="Primary, Secondary and Arbiter" /></p>

<h2 id="replica-set">Replica Set</h2>

<p>Setting up a Replica Set with MongoDB is very straight forward. It is recommended that you use three servers for a replica set. Two of which should be more or less dedicated to MongoDB, while the third is the arbiter, and can run on another server that isn’t necessarily dedicated to MongoDB. The arbiter isn’t resource intense, and is only used to keep track of the other two servers and vote for which one should be the primary.</p>

<p>The process of setting up a replica set is simple and the instructions can be found <a href="http://www.mongodb.org/display/DOCS/Replica+Set+Configuration">here</a>. The only thing you might want to do differently from that guide is to instead of adding two nodes, add one node and one arbiter (using the command ‘rs.addArb(“node:port)’).</p>

<p>We also found it handy to set priorities for the two replica nodes. We can do this by simply bumping the node we prefer to be the primary to ’2′ using the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cfg = rs.conf()
cfg.members\[0\].priority = 2
rs.reconfig(cfg)
</code></pre></div></div>

<p>Please note that cfg.member[N] is the list item from the top (the first one being 0). It’s <strong>not</strong> the id. More information is available <a href="http://www.mongodb.org/display/DOCS/Reconfiguring+when+Members+are+Up">here</a>.</p>

<p>In case you need to take down the primary server for maintenance, you should use the StepDown-command. This will gracefully force the primary server to step down. To do this, log into the server and issue the following command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use admin
rs.stepDown()
</code></pre></div></div>

<p>Once you’ve validated that the server is ‘secondary’ you can shut the server down without worrying about dataloss.</p>

<p>There are two other commands that you should also be aware about. The first command is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>rs.status()
</code></pre></div></div>

<p>This command gives you information about your replica set and replication.</p>

<p>The second dommand is:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.serverStatus()
</code></pre></div></div>

<p>This will give you detailed information about the individual node.</p>

<h2 id="let-the-sharding-begin">Let the sharding begin</h2>

<p>Sharding is a bit more tricky than setting up a simple replica set, but a lot easier than sharding a sequel database. While it is not necessary that each member of a shard is a replica set, it is highly recommended for redundancy purposes. Hence, the way you should be thinking about sharding in MongoDB as a way to consolidate multiple replica sets.</p>

<p>Here’s an illustration of how one would expand the replica set we described above with a shard.<br />
<img src="https://vpetersson.com/upload/shard.png" alt="" title="Sharded" /></p>

<p>Let’s now assume that you have two replica sets configured and ready to go. How do you turn them into a shard?</p>

<p>The first thing you will need is to set up config-servers and mongos-nodes. The config-servers holds critical data about your shard(s). If that data gets lost, you’re basically toast. Hence, you want at least three of these servers. Mongos is the router that all your nodes will communicate against. The clients won’t be able to tell the difference if they are talking to a mongos or a regular replica set, which is nice.</p>

<p>You will also need to restart mongod with a few new flags.</p>

<p>To spin up a regular mongod-node (primary or secondary), use this command (assuming the replica set name is ‘repl0′:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u mongodb mongod --shardsvr --replSet repl0 --dbpath /mongo/repl0 --fork --logpath /var/log/mongodb/repl0.log
</code></pre></div></div>

<p>To spin up a config-server, use the following command (note oplogsize is set to 1 to minimize disk space being wasted):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u mongodb mongod --configsvr --dbpath /mongo/configsvr --fork -–oplogSize 1 --logpath /var/log/mongodb/configsvr.log
</code></pre></div></div>

<p>Finally, you need to spin up the mongos (we assume node1, node2, node 4 and node5 are the config-servers):</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo -u mongodb mongos --configdb :,:,:,: --fork --logpath /var/log/mongodb/mongos.log
</code></pre></div></div>

<p>Once you have all the servers up and running, it’s time to start sharding.</p>

<p>Start by opening a mongo-session against one of the mongos-servers. Now we need to add the replica sets to the the shard:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use admin
db.runCommand( { addshard : "repl0/:,:,:", maxSize:10000/\*MB\*/ } );
db.runCommand( { addshard : "repl1/:,:,:", maxSize:10000/\*MB\*/ } );
</code></pre></div></div>

<p>The should add both replica sets to the shard. We also specified that the maximum storage each replica set should hold to 10GB. Please note that this is a soft limit, and the balancer will use this as a guideline to evenly spread the data.</p>

<p>Now we have prepared everything that needed preparation. Now it’s time to actually shard the data. Let’s assume that we have a collection/database named MyStuff that we want to shard. Let’s also assume that this is primarily used for GridFS.</p>

<p>Once again, log into mongos, but now run the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use admin
db.runCommand( { enablesharding : "MyStuff" } );
</code></pre></div></div>

<p>Next we need to tell Mongo how to shard the data. Let’s use the files_id:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>use MyStuff
db.fs.chunks.ensureIndex( { files_id: 1 } );
db.fs.files.ensureIndex( { files_id: 1 } );
db.runCommand( { shardcollection : "db.fs.chunks", key : { files_id : 1 } } )
db.runCommand( { shardcollection : "db.files.chunks", key : { files_id : 1 } } )
</code></pre></div></div>

<p>Depending on your load, using files_id can be a bad idea as won’t evenly distribute the load across the nodes. However, this is a whole different topic.</p>

<p>Once you got everything setup, you might want to know more about how your system. There are a few commands that will give you a good overview about your system (in addition to the ones mentioned above).</p>

<p>To get more information about your system, you might find the following commands useful:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.printShardingStatus()
db.runCommand( { listShards : 1} );
</code></pre></div></div>

<p>Another useful command, if you need to reorganize your setup, is removeshard:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>db.runCommand( { removeshard : "repl0" } );
</code></pre></div></div>

<p>It’s likely that you want to learn more about MongoDB before you get started. I would then recommend the following resource:</p>

<ul>
  <li><a href="http://www.mongodb.org/display/DOCS/Sharding+Introduction">Sharding Introduction</a></li>
  <li><a href="http://www.mongodb.org/display/DOCS/Configuring+Sharding">Configuring Sharding</a></li>
  <li><a href="http://www.mongodb.org/display/DOCS/Choosing+a+Shard+Key">Choosing a Shard Key</a></li>
  <li><a href="http://www.snailinaturtleneck.com/blog/2011/01/04/how-to-choose-a-shard-key-the-card-game/">How to Choose a Shard Key: The Card Game</a></li>
</ul>

<p>Please note that I’m by no means a MongoDB guru, but feel free to drop a comment below, and I’ll try to answer.</p>


      <div class="mt-12 mb-8 p-8 bg-blue-50 border border-blue-100 rounded-xl">
        <h4 class="text-2xl font-semibold mb-4 text-blue-900">Enjoyed this post? Check out my podcast!</h4>
        <p class="mb-6 text-blue-800">If you found this interesting, you might enjoy <a href="/podcast" class="text-blue-600 hover:text-blue-800 underline" onclick="trackEvent('Blog CTA', 'Click', 'Podcast Link', 'Notes on MongoDB, GridFS, sharding  and deploying in the cloud')">"Nerding Out with Viktor"</a> - my podcast where I dive deep into tech, entrepreneurship, and security with industry experts.</p>
        <div>
          <h5 class="font-medium mb-4 text-blue-900">Listen on:</h5>
          



<div>
  <div class="flex gap-3">
    
      <a href="https://www.youtube.com/@nerdingoutwithviktor" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'YouTube', 'Notes on MongoDB, GridFS, sharding  and deploying in the cloud')">
        <img src="/assets/images/site/podcast-youtube-white.svg" alt="Listen to podcast on YouTube" />
      </a>
    
    
      <a href="https://open.spotify.com/show/7C6yipdVPWgBc6Bwikgo8g" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'Spotify', 'Notes on MongoDB, GridFS, sharding  and deploying in the cloud')">
        <img src="/assets/images/site/podcast-spotify-white.svg" alt="Listen to podcast on Spotify" />
      </a>
    
    
      <a href="https://podcasts.apple.com/us/podcast/nerding-out-with-viktor/id1722663295" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'Apple', 'Notes on MongoDB, GridFS, sharding  and deploying in the cloud')">
        <img src="/assets/images/site/podcast-apple-white.svg" alt="Listen to podcast on Apple" />
      </a>
    
    
    
      <a href="https://podcast.nerdingoutwithviktor.com/podcast_feed.xml" target="_blank" rel="noopener noreferrer" onclick="trackEvent('Podcast', 'Click', 'RSS', 'Notes on MongoDB, GridFS, sharding  and deploying in the cloud')">
        <img src="/assets/images/site/podcast-rss-white.svg" alt="RSS Feed" />
      </a>
    
  </div>
</div>

        </div>
      </div>

      <i>Found an error or typo? File PR against <a href="https://github.com/vpetersson/vpetersson.com/tree/master/_posts/tumblr/2012-01-29-notes-on-mongodb-gridfs-and-sharding-in-the-cloud.md" rel="nofollow">this file</a>.</i>
    </article>
    <div class="mt-6">
      
  <div class="tags">
    
      <a href="/tags/mongodb" class="tag">
        MongoDB
      </a>
    
  </div>


    </div>
  </div>
</div>


    </main>
    <footer class="py-[60px] md:pt-[74px] md:pb-[40px] px-[25px] md:px-[120px] text-altPrimaryText">
  <div class="mb-[60px]">
    <a href="/">
      <img class="w-[200px] md:w-[320px]" src="/assets/images/site/logo.svg" alt="logo" />
    </a>
  </div>
  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center mb-8 lg:mb-6">
    <nav class="flex flex-col md:flex-row gap-6 md:gap-8 mb-20 lg:mb-0">
      
        <a href="/" class="">HOME</a>
      
        <a href="/about" class="">ABOUT</a>
      
        <a href="/consulting" class="">CONSULTING</a>
      
        <a href="/podcast" class="">PODCAST</a>
      
        <a href="/blog" class="">BLOG</a>
      
        <a href="https://studio.viktopia.io/" class="">VIKTOPIA STUDIO</a>
      
    </nav>
    <div class="flex gap-[13px]">
      <a href="https://twitter.com/vpetersson">
        <img src="/assets/images/site/x.svg" alt="x logo" />
      </a>
      <a href="https://github.com/vpetersson">
        <img src="/assets/images/site/github.svg" alt="github logo" />
      </a>
      <a href="https://www.linkedin.com/in/vpetersson/">
        <img src="/assets/images/site/linkedin.svg" alt="linkedIn logo" />
      </a>
    </div>
  </div>
  <hr class="mb-8 lg:mb-10 bg-[#000212] h-[3px] bg-opacity-20 border-0" />
  <div>
    <p class="font-[Inter] text-base">&copy; Viktor Petersson</p>
  </div>
</footer>

    <script src="/assets/js/main.js" defer></script>
    <script src="/assets/js/code-blocks.js" defer></script>
  </body>
</html>
